---
title: "Data exploration, statistical analyses and setting ground for the plots"
output: 
  html_document:
    toc: true
author: "Tomasz Włodarczyk"
date: "2023-11-10"
vignette: >
  %\VignetteIndexEntry{Data_workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(overwintering)
```

# Introduction
This vignettes replicates the data workflow used to generate the results shown in the following publication:

[Włodarczyk T. 2021. Functional spatial distribution and sociometric characteristics of Formica fusca ants during winter dormancy. Ecological Entomology 46, 419–427.](https://resjournals.onlinelibrary.wiley.com/doi/10.1111/een.12983)

I also provide the additional data, which have not previously been published in any form and regarding spatial distribution of ants.

# Colony spatial distribution during the winter dormacy
The `spatial_distribution` dataset contains the raw data collected in the field. As the ants were excavated the position of ant cluster was determined in two ways: measuring the depth range occupied by an ant cluster, and measuring the distance from the cluster center to the three reference points arranged arounf the nest site. The cluster center was  projected upwards to the ground level so that the points were assumed to lie on the same plane. To account for the dimensions of the cluster on the horizontal plane, the radius from the clutser center was also measures (taking rather the upper etimate of it). Thus, the whole cluster was represented as a vertically positioned cylinder. 

```{r}
data("spatial_distribution")
head(spatial_distribution)
```

As we can see from the head of the dataset it also contains the date indicating when a given cluster was found. The whole excavation took usually several days.

```{r}
res <- split(spatial_distribution, spatial_distribution$Colony) |>
  lapply(function(x) cat(sprintf("Excavation period for the colony %s: %d days\n", x$Colony[1], as.integer(max(x$Date)-min(x$Date)+1))))

```

To transform the ditsances of projected cluster positions to their coorinated on the horizontal plane we need the coordinates of the reference points. They can be easily calculated having the mutual ditances among them. The problem reduces to finding triangle vertices given the side lenghts. 

```{r}
# load the data on the distances among reference points for each colony
data("reference_points")

# calculate the reference points coordinates
reference_points_coords <- distances_to_coordinates(reference_points)
```

Now we can add to the `spatial_distribution` dataset the columns with the cluster center coordinates on the horizontal plane. Note that this is available for the samples in which distances to the reference points have been determined. This was not the case for some of the colonies and samples with low number of ants or ants whose intact position could not be determined. Since the measurements inevitably entail the error component, the exact solution from geometric calculation are usually not available. This is why the solutuion is obtained through the optimization function, which looks for the position of the cluster center such that the distances to the reference points are close to the reported ones. 

```{r}
spatial_distribution <- add_point_coordinates(spatial_distribution, reference_points_coords)
```

## Vertical distribution plot
To construct the plot showing the vertical distriution of plot we should first prepare a correct data representation. We will divide each cluster into segments, each of which will cover the depth of one centimeter. Ants are assumed to be evenly distributed across these segments and lastly, segments representing the same depth are summed up across the clusters. 

```{r fig.dim=c(10,8)}
vertical_distribution_plot <- determine_vertical_distribution(spatial_distribution)

# load dataset with colony metadata
data("colony_metadata")

# render the main part of the Fig 3 from the publication
vertical_distribution_plot(vertical_distribution_plot, colony_metadata)
```

We can plot separately the legend to the Figure 3.
```{r fig.dim=c(6,8)}
plot_legend_fig_3()
```

# Forager removal experiment

The dataset `time_series_results` presents the outcome of the experiment in which part of workers were marked with the color used being dependent on whether ant occipied the upper or lower part of the excavated nest. In the laboratory ants penetrating the area outside the aritifical nests were collected on a daily basis producing the time series data. The dataset presents the cumulative results as the experiment was going on. The paint colors used to differentiate between both categories of ants were swept across colonies. 

```{r}
data("time_series_results")
head(time_series_results)
```
 
We can check the final experiment output for each colony.

```{r}
for(colony in unique(time_series_results$colony)){
  max_ind <- which.max(time_series_results[time_series_results$colony==colony,"Date"])
  print(time_series_results[time_series_results$colony==colony,][max_ind,,drop=FALSE])
}
```

To perform statistical calculations we need some quantitive data related to the ant marking. They are included in the `colony_stats` dataset.

```{r}
data("colony_stats")
colony_stats
```

With these numbers we can calculate the probability for each possible proportion of ants from upper (or lower) part of the nest among
all the ants which have been removed.

## Figure 5
```{r message=FALSE, fig.dim=c(10,3)}
figure_5()
```

## Figure 6
```{r message=FALSE, fig.dim=c(10,3)}
figure_6()
```